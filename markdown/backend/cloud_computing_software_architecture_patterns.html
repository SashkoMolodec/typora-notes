<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
    margin: 0 auto;
    padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
    #write {
        max-width: 1024px;
    }
}

@media only screen and (min-width: 1800px) {
    #write {
        max-width: 1200px;
    }
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
    background-color: #f8f8f8;
}
#write pre.md-meta-block {
    padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
    bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
    left: -1.5625rem;
    top: .375rem;
}
#write>h4.md-focus:before{
    left: -1.5625rem;
    top: .285714286rem;
}
#write>h5.md-focus:before{
    left: -1.5625rem;
    top: .285714286rem;
}
#write>h6.md-focus:before{
    left: -1.5625rem;
    top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}



mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
                            stroke-width: 0;
                        }
</style>
<title>cloud_computing_software_architecture_patterns</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h2 id='cloud-computing-software-architecture-patterns'><span>Cloud Computing Software Architecture Patterns</span></h2><p><a href='backend_index'>◀️</a></p><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h2"><a class="md-toc-inner" href="#cloud-computing-software-architecture-patterns"><span>Cloud Computing Software Architecture Patterns</span></a></span><span role="listitem" class="md-toc-item md-toc-h3"><a class="md-toc-inner" href="#scalability-patterns"><span>Scalability Patterns</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#load-balancing"><span>Load Balancing</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#pipes-and-filters"><span>Pipes and Filters</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#scatter-gather"><span>Scatter Gather</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#execution-orchestrator"><span>Execution Orchestrator</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#choreography"><span>Choreography</span></a></span><span role="listitem" class="md-toc-item md-toc-h3"><a class="md-toc-inner" href="#performance-patterns"><span>Performance Patterns</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#map-reduce"><span>Map Reduce</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#saga"><span>Saga</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#transactional-outbox"><span>Transactional Outbox</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#materialized-view"><span>Materialized View</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#cqrs"><span>CQRS</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#cqrs-+-materialized-view-for-microservices-architecture"><span>CQRS + Materialized View for Microservices Architecture</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#event-sourcing"><span>Event Sourcing</span></a></span><span role="listitem" class="md-toc-item md-toc-h3"><a class="md-toc-inner" href="#extensibility-patterns"><span>Extensibility Patterns</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#sidecar"><span>Sidecar</span></a></span><span role="listitem" class="md-toc-item md-toc-h5"><a class="md-toc-inner" href="#ambassador-sidecar"><span>Ambassador Sidecar</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#anti-corruption-adapter/later"><span>Anti-Corruption Adapter/Later</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#bffs---backends-for-frontends"><span>BFFs - Backends For Frontends</span></a></span><span role="listitem" class="md-toc-item md-toc-h3"><a class="md-toc-inner" href="#reliability,-error-handling-and-recovery-patterns"><span>Reliability, Error Handling and Recovery Patterns</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#throttling-and-rate-limiting"><span>Throttling and Rate Limiting</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#retry"><span>Retry</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#circuit-breaker"><span>Circuit Breaker</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#dead-letter-queue"><span>Dead Letter Queue</span></a></span><span role="listitem" class="md-toc-item md-toc-h3"><a class="md-toc-inner" href="#software-deployment-patterns"><span>Software Deployment Patterns</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#rolling-deployment"><span>Rolling Deployment</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#blue-green-deployment"><span>Blue-Green Deployment</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#canary-release"><span>Canary Release</span></a></span><span role="listitem" class="md-toc-item md-toc-h3"><a class="md-toc-inner" href="#production-testing-patterns"><span>Production Testing Patterns</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#a/b-testing"><span>A/B Testing</span></a></span><span role="listitem" class="md-toc-item md-toc-h4"><a class="md-toc-inner" href="#chaos-engineering"><span>Chaos Engineering</span></a></span></p></div><p><span></span><strong><span>Benefits</span></strong><span> of Cloud Computing Pattern:</span></p><ul><li><p><span>Access to (virtually) infinite:</span></p><ul><li><span>Computation</span></li><li><span>Storage</span></li><li><span>Network вау вау</span></li></ul><p><span>Infrastructure as a Service (</span><strong><span>IaaS</span></strong><span>)</span></p></li><li><p><span>Without the IaaS every company would have to hire specialists and build infrastructure</span></p></li><li><p><span>Cloud&#39;s pricing model charges </span><strong><span>only</span></strong><span> for services we use and hardware we reserve</span></p></li><li><p><span>Removes entry barrier for new companies</span></p></li><li><p><span>Tools/features to improve: </span></p><ul><li><span>Performance</span></li><li><span>Scalability</span></li><li><span>Reliability</span></li></ul><p><span>For example multi-region, multi-zone deployment</span></p></li></ul><p><span>Two major </span><strong><span>disadvantages</span></strong><span>:</span></p><ul><li><span>We don&#39;t own our system&#39;s infrastructure</span></li><li><span>Cloud infrastructure is out of our direct control</span></li></ul><p>&nbsp;</p><hr /><h3 id='scalability-patterns'><span>Scalability Patterns</span></h3><h4 id='load-balancing'><span>Load Balancing</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/1.png" alt="image-20230317222610130" style="zoom:50%;" /></p><p><span>There may be a few instances of load balancers as well. If it fails it automatically restarts. Message brokers are also scalable.</span></p><p><span>Do not use message brokers as load balancers (not their main purpose). One of the exception is when the communication between users and services is async and receiver is not waiting for some message in response. </span></p><p><span>Message brokers are used as internal communication between services. </span></p><p><span>Implementation considerations:</span></p><ul><li><p><span>Which algorithm to use for routing requests to workers?</span></p><ul><li><span>round robin (the load balancer is routing each incoming request sequentially to the next worker instance) - usually a default load balancing algorithm; doesn&#39;t work when we need to have some session between user and server (after user authentication, when sending large files in many request)</span></li><li><span>sticky session (as long as server healthy request will be handled only to it, achieved by a cookie on the client&#39;s device and each sent request); works great only for relatievely short sessions</span></li><li><span>least connections (route new requests to servers that have the least number of already established connections) </span></li></ul></li><li><p><span>Auto-scaling</span></p><ul><li><span>Use data collected from metrics for auto-scaling policy</span></li></ul></li></ul><p>&nbsp;</p><hr /><h4 id='pipes-and-filters'><span>Pipes and Filters</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/2.png" alt="image-20230317222533220" style="zoom:50%;" /></p><p><span>Problems solved by Pipes and Filters pattern:</span></p><ul><li><span>Tight coupling - can&#39;t use different languages for different tasks
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/3.png" alt="image-20230317200002234" style="zoom:50%;" /></li><li><span>Hardware restrictions - each task my require different hardware (extra CPU, extra memory, fast network, GPU)</span></li><li><span>Low Scalability - each task may requre a different number of instances</span></li></ul><p><span>The entire pipeline can run optimally in terms of:</span></p><ul><li><span>Performance</span></li><li><span>Cost</span></li><li><span>Will be highly scalable </span></li></ul><p><span>Used extensively for processing streams of data about user activity (digital advertising), data from IOT, image and video processing.
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/4.png" alt="image-20230317201231970" style="zoom:50%;" /></p><p><span>Important considerations:</span></p><ul><li><span>Involves additional overhead and complexity</span></li><li><span>Each filter need to be stateless, and should be provided enough information as part of its input</span></li><li><span>Not a good fit for &quot;transactions&quot; (where atomicity and consistency are important)</span></li></ul><p>&nbsp;</p><hr /><h4 id='scatter-gather'><span>Scatter Gather</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/5.png" alt="image-20230317222501692" style="zoom:50%;" /></p><p><span>Example of search services:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/6.png" alt="image-20230317223432069" style="zoom:50%;" /></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/7.png" alt="image-20230317223556386" style="zoom:50%;" /></p><p><span>Generally 3 use cases:</span></p><ul><li><span>Internal instances of the same service with access to different data</span></li><li><span>Different services with different functionality</span></li><li><span>External services that belong to other companies</span></li></ul><p><span>Observations:</span></p><ul><li><span>Number of workers is transparent to the user</span></li><li><span>Users are not aware of whether the workers are internal or external</span></li><li><span>Scatter gather pattern is a great choice for high scalability</span></li></ul><p><span>Important considerations:</span></p><ul><li><span>Workers can become unreachable/unavailable at any moment - need maintaining reliability despite external issues</span></li><li><span>Decoupling dispatcher from workers:</span></li></ul><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/8.png" alt="image-20230317225829579" style="zoom:50%;" /></p><ul><li><span>The time between the request and the result (maybe support for long running reports)</span></li></ul><p>&nbsp;</p><hr /><h4 id='execution-orchestrator'><span>Execution Orchestrator</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/9.png" alt="image-20230317233014842" style="zoom:50%;" /></p><p><span>Extension of the Scatter Gather pattern. We don&#39;t have one operation to perform in parallel, but instead we have a sequence of operations (can be parallel or sequential).</span></p><p><span>Situation: user tries to register but in the middle of the process orchestrator dies, user resubmitted registration and other orchestrator took that process. When it calls User service it fails due to previous already complete steps. 
The solution is to save states so orchestrator could pick up tasks if any of other fails:
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/10.png" alt="image-20230318113059717" style="zoom:50%;"/></p><p>&nbsp;</p><p><span>Common mistake - start adding business logic into the Orchestration service. If the Orchestration service becomes too smart it just becomes a monolith. So the scope of its work should stay within the boundaries of orchestration.</span></p><p><span>Drawbacks:</span></p><ul><li><p><span>Tight coupling between all the microservices in the system - </span><strong><span>distributed monolith anti-pattern</span></strong><span>:</span></p><ul><li><span>get problems of a monolith architecture</span></li><li><span>get issues of microservices architecture</span></li><li><span>get no benefits of microservices architecture</span></li></ul><p><span>Solution - Choreography software architecture pattern</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/11.png" alt="image-20230318115116637" style="zoom:50%;" /></p><p>&nbsp;</p></li></ul><p>&nbsp;</p><hr /><h4 id='choreography'><span>Choreography</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/12.png" alt="image-20230318114612375" style="zoom:50%;" /></p><p><span>Follow the analogy of a sequence of steps in a dance - perform theirs steps when it&#39;s their turn to complete the entire flow of operations as a group.</span></p><ul><li><p><span>Communication is async (without any central entity), we can easily:</span></p><ul><li><span>Make changes to the system</span></li><li><span>Add/Remove services</span></li></ul></li><li><p><span>Scale any flow to many services</span></p></li><li><p><span>Scale our organization easily</span></p></li></ul><blockquote><p><span>Function as a service - they don&#39;t consume any resources untill someone triggers their execution. Turn on, get the job done, turn off.</span></p></blockquote><p><span>Downsides: </span></p><ul><li><p><span>No centralized orchestrator -</span></p><ul><li><span>A lot harder to troubleshoot (so need to write more integration tests)</span></li><li><span>A lot harder to trace the flow of events </span></li></ul></li></ul><p><span>An example:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/13.png" alt="image-20230318121200176" style="zoom:50%;" /></p><p><span>Choreography pattern is more suitable for:</span></p><ul><li><span>Simple flows</span></li><li><span>Fewer services</span></li></ul><p>&nbsp;</p><hr /><h3 id='performance-patterns'><span>Performance Patterns</span></h3><h4 id='map-reduce'><span>Map Reduce</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/14.png" alt="image-20230322182516143" style="zoom:120%;" /></p><p><span> Use cases:</span></p><ul><li><span>Machine learning</span></li><li><span>Filtering and analyzing logs</span></li><li><span>Inverted index construction</span></li><li><span>Web link graph traversal</span></li><li><span>Distributed sort</span></li><li><span>Distributed search</span></li></ul><p><span>Classic example - count word occurrences across many text files:
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/15.png" alt="image-20230323110853837" style="zoom:50%;" /></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/16.png" alt="image-20230323110928052" style="zoom:50%;" /></p><p><span>Other example:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/17.gif" referrerpolicy="no-referrer" alt="map_reduce_example"></p><blockquote><p><span>The process of transferring data from the mappers to reducers is </span><strong><span>shuffling</span></strong><span>.  It is also the process by which the system performs the sort. Then it transfers the map output to the reducer as input. This is the reason shuffle phase is necessary for the reducers.</span></p></blockquote><p><span>Map reduce programming model allows to:</span></p><ul><li><span>reuse the same software architecture</span></li><li><span>scale the processing of a task</span></li><li><span>run computations in parallel by many workers</span></li></ul><p><span>The result:</span></p><ul><li><span>processing of massive amounts of data in short time</span></li></ul><p>&nbsp;</p><hr /><h4 id='saga'><span>Saga</span></h4><p><span>How do we manage data consistency across microservices within a distributed transaction? </span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/18.png" alt="image-20230323115002067"  /></p><p><span>Saga pattern can be implemented using:</span></p><ul><li><span>Execution Orchestrator pattern</span></li><li><span>Choreography pattern</span></li></ul><p><span>With either of the impl we can execute transactions:</span></p><ul><li><span>that span multiple services</span></li><li><span>without a centralized database</span></li></ul><p><span> </span></p><hr /><h4 id='transactional-outbox'><span>Transactional Outbox</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/19.png" referrerpolicy="no-referrer" alt="image-20230323125057106"></p><ul><li><span>The update action to Users db (blue) and message action to Outbox db (green) are always a single transaction</span></li><li><span>The Message Relay Service monitors the Outbox database and as soon as the new message appears in that table, it takes that message and sends it to the message broker and marks as send or just deletes it</span></li></ul><p><span>Transactional Outbox:</span></p><ul><li><span>Solves the problem of losing data/messages</span></li><li><span>Guarantees that for each database update we trigger the appropriate event</span></li></ul><p><span>Issues and considerations:</span></p><ul><li><p><span>Duplicate events</span></p><ul><li><span></span><em><strong><span>At Least Once</span></strong></em><span> - Delivery Semantics
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/20.png" alt="image-20230323131417684" style="zoom:50%;" /></li><li><span></span><strong><span>Idempotent</span></strong><span> operations (not breaking anything if called multiple times) - don&#39;t need any special handling</span></li></ul></li><li><p><span>No support for Transactions (if our microservice is using some noSQL database, such a document store)</span></p><ul><li><span>Solved by adding fields to the original database document (this operation would be typically an atomic)
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/21.png" alt="image-20230323131717241" style="zoom:50%;" /><span>
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/22.png" alt="image-20230323131821820" style="zoom:50%;" /><span>
When Relay service finds an outbox in the user, it sends the event to message queue and removes the outbox field from user in the table.</span></li></ul></li><li><p><span>Ordering of Events</span></p><p><span>Solution - sequence id should be bigger then previous for ability to sort the events when Message Relay service performs a query
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/23.png" alt="image-20230323132217488" style="zoom:50%;" /></p></li></ul><p>&nbsp;</p><hr /><h4 id='materialized-view'><span>Materialized View</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/24.png" alt="image-20230323142233708" style="zoom:80%;" /></p><p><span>An example:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/25.png" referrerpolicy="no-referrer" alt="image-20230323143301882"></p><p><span> Important considerations:</span></p><ul><li><p><span>Additional space for Materialized View</span></p><ul><li><p><span>Trade Offs</span></p><ul><li><span>Additional space for high performance</span></li><li><span>In the cloud - cost for high performance</span></li></ul></li></ul></li><li><p><span>Where to store the Materialized View?</span></p><ul><li><span>In the same db as the original data (can be feature out-of-box with some automatic updates)
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/26.png" alt="image-20230323144226489" style="zoom:50%;" /><span>
downside - may not be the most optimal for reading and querying data</span></li><li><span>Store in a separate, read-optimized database 
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/27.png" alt="image-20230323144518586" style="zoom:50%;" /><span>
need to take extra care and effort to keep the materialized view up to date with the original data</span></li></ul></li></ul><p>&nbsp;</p><hr /><h4 id='cqrs'><span>CQRS</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/28.png" alt="image-20230323155040343" style="zoom:80%;" /></p><p><span>When we perform some action on the data stored in db we can split them in 2 types:</span></p><ul><li><span>Command - an action we perform that results in data mutation (add, update , delete)</span></li><li><span>Query - only read data and returns to the caller </span></li></ul><p><span>We may pick the best db technology for the command type operations and the same for query type (so they may differ):
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/29.png" alt="image-20230323155457248" style="zoom:50%;" /></p><p><span>Synchronization through sending events:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/30.png" alt="image-20230323155705842" style="zoom: 80%;" /></p><ol><li><span>We may implement this with message broker, but are we sure about the single transaction when updating the command db and query db? The answer to that is to use </span><strong><span>transactional outbox pattern</span></strong><span>:
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/31.png" alt="image-20230323160043997" style="zoom: 50%;" /><span>  
The message broker will not delete the event until the query service successfully consumes it and updates its database, we are guaranteed that we will not lose any update.</span></li><li><span>Function as a service
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/32.png" alt="image-20230323160438605" style="zoom: 50%;" /></li></ol><p><span>Issues/Drawbacks:</span></p><ul><li><p><span>We can only guarantee Eventual Consistency between the Command and Query dbs, but not strict consistency</span></p><blockquote><p><span>Strong consistency means the latest data is returned, but, due to internal consistency methods, it may result with higher latency or delay. With eventual consistency, results are less consistent (not the latest) early on, but they are provided much faster with low latency.</span></p></blockquote></li><li><p><span>Overhead and complexity (separated services and synchronization part)</span></p></li></ul><p><span>Online store example:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/33.png" alt="image-20230323161633374" style="zoom:80%;" /></p><p><span>With that event message we update the noSQL Reviews collection. If the checking review count exceeds some number then we calculate product rating and insert it in Product Ratings collections.
We have the possibility for scaling out the Query Service part as the load will be much higher.</span></p><p>&nbsp;</p><hr /><h4 id='cqrs-+-materialized-view-for-microservices-architecture'><span>CQRS + Materialized View for Microservices Architecture</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/34.png" alt="image-20230323162307135" style="zoom:80%;" /></p><p><span>FaaS approach:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/35.png" alt="image-20230323174202944" style="zoom:80%;" /></p><p><span>Cloud function will update the materialized view - eventually consistent.</span></p><p><span>An example:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/36.png" alt="image-20230323174621831" style="zoom:80%;" /></p><p><span>Using CQRS + Materialized View we were able to solve an important problem in microservices architecture:</span></p><ul><li><span>Joining data from multiple microservices with separate databases</span></li></ul><p><span>By using:</span></p><ul><li><span>Materialized View, we placed the joined data in a separate table</span></li><li><span>CQRS, we stored the materialized view in separate read optimized database. Each behind its own microservice</span></li><li><span>Event Driven Architecture, we keep the external Materialized View up-to-date with the original data</span></li></ul><p>&nbsp;</p><hr /><h4 id='event-sourcing'><span>Event Sourcing</span></h4><p><span>Event Sourcing is a pattern for storing data as events in an append-only log.</span></p><p><span>In certain situations we need to know the current status and every previous state. Reasons are for visualization, auditing, corrections.</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/37.png" alt="image-20230323180131027" style="zoom:80%;" /></p><p><span>An example:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/38.png" alt="image-20230323181519206" style="zoom:80%;" /></p><p><span>We may also provide insights such as advice for better spending habits or recommend other products.</span></p><p><span>Where to store events:</span></p><ul><li><span>DB - each in separate record </span></li><li><span>Storing events in message broker</span></li></ul><p><span>Problem we solve:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/39.png" alt="image-20230323182136654" style="zoom:80%;" /></p><p><span>all updates with each other and slow down as well as all the readers of that table.</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/40.png" alt="image-20230323182232697" style="zoom:80%;" /></p><p><span></span><strong><span>Strategies</span></strong><span> for replaying events:</span></p><ul><li><span>Snapshots
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/41.png" alt="image-20230323182430217" style="zoom:50%;" /></li><li><span>CQRS pattern
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/42.png" alt="image-20230323182624102" style="zoom:80%;" /><span>
Very popular, because we get </span><strong><span>history</span></strong><span> and </span><strong><span>auditing</span></strong><span>, we get fast and efficient writes, we get fast and efficient reads.</span></li></ul><p>&nbsp;</p><hr /><h3 id='extensibility-patterns'><span>Extensibility Patterns</span></h3><h4 id='sidecar'><span>Sidecar</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/43.png" alt="image-20230324083420025" style="zoom:80%;" /></p><p><span>Issues with a shared library:</span></p><ul><li><p><span>Scalability</span></p></li><li><p><span>Incompatibility of inconsistency between different languages</span></p><ul><li><span>different data types</span></li><li><span>bugs in different versions of implementations</span></li></ul></li></ul><p><span>The main application is isolated from a sidecar process but at the same time they both run on same host - for a fast, reliable communication. They both have access to the same internal server resources.</span></p><p><span>Sidecar Pattern extends the functionality of a service</span></p><ul><li><span>No need to reimplement in every programming language</span></li><li><span>No need to deploy as a service on additional hardware</span></li></ul><p><span>Sidecar benefits:</span></p><ul><li><span>Isolation between the sidecar and the core application</span></li><li><span>Has access to the same resources</span></li><li><span>Low overhead of interprocess communication</span></li></ul><h5 id='ambassador-sidecar'><span>Ambassador Sidecar</span></h5><p><span>Ambassador is a special sidecar that is responsible for sending all the network requests on behalf of the service - like a proxy, but it runs on the same host as the core application.</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/44.png" alt="image-20230324084916882" style="zoom:50%;" /></p><p><span>Troubleshoot transactions:</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/45.png" alt="image-20230324085048826" style="zoom:80%;" /><span> </span></p><p>&nbsp;</p><hr /><h4 id='anti-corruption-adapter/later'><span>Anti-Corruption Adapter/Later</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/46.png" alt="image-20230324100710581" style="zoom:80%;" /></p><p><span>2 scenarios:</span></p><ul><li><span>Migration between architectures</span></li><li><span>Running 2 systems permanently side-by-side</span></li></ul><p><span>Overhead</span></p><ul><li><p><span>Anti-Corruption will always have some</span></p><ul><li><span>Performance overhead (latency) </span></li><li><span>Additional cost (may develop FaaS solution)</span></li></ul></li></ul><p>&nbsp;</p><hr /><h4 id='bffs---backends-for-frontends'><span>BFFs - Backends For Frontends</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/47.png" alt="image-20230324145756365" style="zoom:65%;" /></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/48.png" alt="image-20230324150150559" style="zoom: 80%;" /></p><p><span>Challenges:</span></p><ul><li><p><span>Multiple backends - How to avoid duplicating shared functionality?</span></p><ul><li><span>Shared libraries (if not so much code with no changing, requires coordination between teams)</span></li><li><span>Separate shared service with clear defined scope
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/49.png" alt="image-20230324150803064" style="zoom:50%;" /></li></ul></li><li><p><span>How many types of Backend For Frontends?</span></p></li></ul><p>&nbsp;</p><hr /><h3 id='reliability,-error-handling-and-recovery-patterns'><span>Reliability, Error Handling and Recovery Patterns</span></h3><h4 id='throttling-and-rate-limiting'><span>Throttling and Rate Limiting</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/50.png" alt="image-20230324154511586" style="zoom:80%;" /></p><p><span>Throttling - set requests limited by Period of Time</span></p><blockquote><p><span>Limits on the bandwidth and set mb or gb of data that can be either sent or read from our system at a given period.</span></p></blockquote><p><span>When exceeds a limit send a response with 429 - Too Many Requests.</span></p><p><span>Considerations:</span></p><ul><li><span>Customer base throttling vs Global (API level) throttling</span></li><li><span>External throttling vs Service based throttling</span></li></ul><p>&nbsp;</p><hr /><h4 id='retry'><span>Retry</span></h4><p><span>Retry pattern attempts to recovery from </span><strong><span>system</span></strong><span> error - delays, timeouts, failures.</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/51.png" alt="image-20230324181312200" style="zoom:80%;" /></p><p><span>Considerations: </span></p><ul><li><p><span>Which errors to retry?</span></p><ul><li><span>Short</span></li><li><span>Temporary (some 503)</span></li><li><span>Recoverable </span></li></ul></li><li><p><span>What delay/backoff strategy to use?</span></p><ul><li><span>Fixed delay
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/52.png" alt="image-20230324182625047" style="zoom:50%;" /></li><li><span>Incremental delay 
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/53.png" alt="image-20230324182655706" style="zoom:50%;" /></li><li><span>Exponential Backoff
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/54.png" alt="image-20230324182739578" style="zoom:50%;" /></li></ul></li></ul><blockquote><p><span>Retry storm - a situation that can cause unrecoverable cascading failure in the system 
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/55.png" alt="image-20230324182236842" style="zoom:50%;" /></p><p><span>It will cause more timeouts and errors which will result in more retries and so on. This way we can easily get to a point where the entire service goes down and can&#39;t recover. </span></p><p><span>As we try to bring it back up, it gets bombarded with more and more retry requests, which newly started instances are not yet ready to handle.</span></p><p><span>Solution - add a delay between subsequent retries.</span></p></blockquote><ul><li><p><span>Adding randomization / Jitter between retries
To make the retry traffic to healthy instances less spiky (imagine request load graph)</span></p></li><li><p><span>How many times / how long to retry?</span></p></li><li><p><span>Is the operation idempotent?
Retrying idempotent op is safe, non-idempotent - not safe</span></p></li><li><p><span>Where to implement the retry logic?</span></p><ul><li><span>Use shared library code</span></li><li><span>Ambassador sidecar pattern
</span><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/56.png" alt="image-20230324183418566" style="zoom:50%;" /></li></ul></li></ul><p>&nbsp;</p><hr /><h4 id='circuit-breaker'><span>Circuit Breaker</span></h4><p><span>Retry pattern - optimistic approach (error is short, tempoty, recoverable), Circuit Breaker - pessimistic approach (more sever and long lasting).</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/57.png" alt="image-20230325161112301" style="zoom:45%;" /></p><p><span>States</span></p><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/58.png" alt="Знімок екрана 2023-03-25 о 18.30.53" style="zoom:40%;" /></p><p><span>The open state goes to half-open automatically after some time and then it passes through a little percentage of requests. If few of them are successful then we get back to closed state.</span></p><p><span>We may replace half-open state with asynchronus ping / health check (save on network bandwidth, CPU and memory resources but need to decide on frequency of pings - if sent too many we may overwhelm the remote service that is already in a bad state; if sending not enough then we may preventing our users from using a healthy service for no reason).</span></p><p><span>As with the Retry pattern we may implement Circuit with shared library or ambassador sidecar pattern.</span></p><p>&nbsp;</p><hr /><h4 id='dead-letter-queue'><span>Dead Letter Queue</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/59.png" alt="image-20230325185142587" style="zoom:45%;" /></p><blockquote><p><span>Event driven architecture - benefits:</span></p><ul><li><span>Decoupling producers from consumers</span></li><li><span>greater scalability</span></li><li><span>async communicaiton</span></li></ul></blockquote><p><span>It&#39;s important to add information about the reason for the failure to the message that gets into the DLQ - Error Details Header, stack trace.</span></p><p>&nbsp;</p><hr /><h3 id='software-deployment-patterns'><span>Software Deployment Patterns</span></h3><h4 id='rolling-deployment'><span>Rolling Deployment</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/60.png" alt="image-20230326133431528" style="zoom:50%;" /></p><p><span>Roll an update gradually: when one instance is not processing any request then the load balancer stops sending requests and instance get updated. If successful then it connects again to load balancer. We complete this process with each instance. </span></p><p><span>It&#39;s very cheap and a lot safer than a big bang approach. But downsides:</span></p><ul><li><span>no isolation between new and old version instances (may break the system)</span></li><li><span>risk of cascading failure (when one instance gets shutdown others will process a lot more requests so they may break) </span></li></ul><p>&nbsp;</p><hr /><h4 id='blue-green-deployment'><span>Blue-Green Deployment</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/61.png" alt="Знімок екрана 2023-03-26 о 13.39.54" style="zoom:50%;" /></p><p><span>Benefits:</span></p><ul><li><span>an equal amount of servers for Blue and Green environments (if we spot a bug on Green env then we just switch back to Blue with all that traffic)</span></li><li><span>single version of the software at any given moment</span></li></ul><p><span>Downsides:</span></p><ul><li><span>twice as many servers as we need - additional cost</span></li></ul><p>&nbsp;</p><hr /><h4 id='canary-release'><span>Canary Release</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/62.png" alt="image-20230326134755891" style="zoom:50%;" /></p><p><span>Borrows from Rolling Deployment and Blue-Green Deployment patterns.</span></p><p><span>Dedicate a small subset of the exisiting group of servers and update their versions. Then with load balancer we let only beta users to those updated servers for performance &amp; other testing. If canary version is good then update all other servers using rolling release for example.</span></p><p><span>Benefits: </span></p><ul><li><span>safety - we have hours or days of testing before rolling out the new version </span></li></ul><p><span>Challenges:</span></p><ul><li><span>setting clear success criteria for automated release and monitoring</span></li></ul><p>&nbsp;</p><hr /><h3 id='production-testing-patterns'><span>Production Testing Patterns</span></h3><h4 id='a/b-testing'><span>A/B Testing</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/63.png" alt="image-20230326141039412" style="zoom:50%;" /></p><p><span>A/B testing goal is testing a new feature. </span><strong><span>We as well dedicate a small portion of servers</span></strong><span> for a different version of software. After testing our version is typically removed and replaced with the previous software version.</span></p><p><span>Users don&#39;t know they are part of an experiment - this gets us genuine data.</span></p><p>&nbsp;</p><hr /><h4 id='chaos-engineering'><span>Chaos Engineering</span></h4><p><img src="../../src/img/backend/microservices/cloud_computing_software_architecture_patterns/64.png" alt="image-20230326141022297" style="zoom:50%;" /></p><p><span>We won&#39;t know about some issues before they actually hapen. Those issues are very rare. But the results can be catastrophic. </span></p><p><span>Solution of chaos engineering: embracing the inherent chaos in a cloud-based distributed system. So we </span><strong><span>systematically inject random but controlled failures</span></strong><span> into our own production systems.</span></p><p><span>Benefits:</span></p><ul><li><p><span>force engineers to thining about failures during develpoment</span></p></li><li><p><span>test the ability of the development team to:</span></p><ul><li><span>monitor</span></li><li><span>recognize outages</span></li><li><span>analyze logs</span></li><li><span>discover production issues</span></li></ul></li></ul><p><span>Real tool is Chaos Monkey - responsible for randomly terminating cloud servers.</span></p><p><span>Failure injection tools:</span></p><ul><li><span>latency injecton (between services or db)</span></li><li><span>restrict access to database (for e.g. test if system can use its replica in another cloud region)</span></li><li><span>resource exhaustion (delibaretly fill up the disk space on a instance or db) </span></li></ul><p><span>Steps to implement:</span></p><ol><li><span>Meaure the baseline</span></li><li><span>Constructing hypothesis - what we expect from the system</span></li><li><span>Inject the failure</span></li><li><span>Monitoring</span></li><li><span>Documenting</span></li><li><span>Restore to the original state</span></li></ol><p><span>Those tests should be performed </span><strong><span>continiously</span></strong><span>.</span></p><p><span>Important considerations:</span></p><ul><li><span>minimizing the &quot;blast radious&quot; of failures to make surue the negative impact on users is minimal</span></li><li><span>stayting within our &quot;error budget&quot;</span></li><li><span>never promising 100% availability to users </span></li></ul></div></div>
</body>
</html>